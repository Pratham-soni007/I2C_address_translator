module i2c_slave_device(
    input  wire scl,
    inout  wire sda,
    input  wire [6:0] dev_addr
);
    reg [7:0] shift_reg;
    reg [3:0] bit_cnt;
    reg sda_oe, sda_out;
    reg addr_match;
    reg rw_bit;

    assign sda = sda_oe ? sda_out : 1'bz;

    always @(posedge scl) begin
        shift_reg <= {shift_reg[6:0], sda};
        bit_cnt <= bit_cnt + 1;

        if (bit_cnt == 7) begin
            if (shift_reg[7:1] == dev_addr) begin
                addr_match <= 1;
                rw_bit <= shift_reg[0];
                $display("[%0t ns] Device 0x%02h selected (R/W=%b)", $time, dev_addr, rw_bit);
            end else addr_match <= 0;
        end

        if (bit_cnt == 8 && addr_match) begin
            sda_oe <= 1;
            sda_out <= 0;
            $display("[%0t ns] Device 0x%02h ACK", $time, dev_addr);
        end else begin
            sda_oe <= 0;
        end
    end
endmodule
