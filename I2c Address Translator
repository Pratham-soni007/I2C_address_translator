`timescale 1ns/1ps

//I2C Address Translator
module i2c_addr_translator(
    input  wire clk,
    input  wire reset_n,
    input  wire scl,
    inout  wire sda,
    input  wire [6:0] old_addr,
    input  wire [6:0] new_addr
);
    reg [3:0] bit_cnt;
    reg [7:0] shift_reg;
    reg sda_out, sda_oe;
    reg [1:0] state;
    reg rw_bit;

    localparam IDLE = 0, RECV = 1;

    assign sda = sda_oe ? sda_out : 1'bz;

    always @(posedge scl or negedge reset_n) begin
        if (!reset_n) begin
            bit_cnt <= 0;
            shift_reg <= 0;
            state <= IDLE;
            sda_oe <= 0;
        end else begin
            case (state)
                IDLE: begin
                    if (sda == 0) begin 
                        bit_cnt <= 0;
                        state <= RECV;
                    end
                end

                RECV: begin
                    shift_reg <= {shift_reg[6:0], sda};
                    bit_cnt <= bit_cnt + 1;
                    if (bit_cnt == 7) begin
                        rw_bit <= sda;
                        if (shift_reg[7:1] == new_addr) begin
                            $display("[%0t ns] Address translated: %02h -> %02h (R/W=%b)",
                                     $time, new_addr, old_addr, rw_bit);
                        end
                    end
                end
            endcase
        end
    end
endmodule
