module tb;
    reg clk = 0;
    always #5 clk = ~clk; 

    reg scl = 1;
    reg sda_drv = 1;
    wire sda = sda_drv ? 1'b1 : 1'b0; /

    reg reset_n = 0;
    localparam [6:0] OLD_ADDR = 7'h3C;
    localparam [6:0] NEW_ADDR = 7'h5A;

    i2c_addr_translator dut (
        .clk(clk),
        .reset_n(reset_n),
        .scl(scl),
        .sda(sda),
        .old_addr(OLD_ADDR),
        .new_addr(NEW_ADDR)
    );

    i2c_slave_device dev1 (.scl(scl), .sda(sda), .dev_addr(OLD_ADDR));
    i2c_slave_device dev2 (.scl(scl), .sda(sda), .dev_addr(7'h3D));

    initial begin
        $dumpfile("i2c_translator_fixed.vcd");
        $dumpvars(0, tb);
        $display("------ I2C Translator Simulation Start ------");

        reset_n = 0;
        #100 reset_n = 1;

        send_start();
        send_byte({NEW_ADDR, 1'b0});
        send_byte(8'hA5);
        send_stop();

        #2000;

        send_start();
        send_byte({7'h3D, 1'b0});
        send_byte(8'h5C);
        send_stop();

        #5000;
        $display("------ Simulation Complete ------");
        $finish;
    end

    task send_start;
        begin
            sda_drv = 1; #200 scl = 1; #200 sda_drv = 0; #200 scl = 0;
            $display("[%0t ns] START condition", $time);
        end
    endtask

    task send_stop;
        begin
            sda_drv = 0; #200 scl = 1; #200 sda_drv = 1; #200 scl = 0;
            $display("[%0t ns] STOP condition", $time);
        end
    endtask

    task send_byte(input [7:0] data);
        integer i;
        begin
            for (i = 7; i >= 0; i = i - 1) begin
                sda_drv = data[i]; #200 scl = 1; #200 scl = 0;
            end
            sda_drv = 1; 
            #200 scl = 1; #200 scl = 0;
            $display("[%0t ns] Master sent byte 0x%02h", $time, data);
        end
    endtask
endmodule
